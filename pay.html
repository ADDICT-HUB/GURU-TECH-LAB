<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout â€” Guru Tech Marketing</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root { --accent: #ff3c00; }
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#071018 0%, #0f0f14 60%);color:#fff;min-width:1200px}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:640px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:22px;border-radius:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(2,6,23,0.7);backdrop-filter:blur(10px)}
    .field{margin-bottom:12px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="tel"], input[type="number"]{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff}
    .confirm-btn{background:var(--accent);color:#fff;padding:12px 14px;border-radius:12px;border:0;font-weight:900;cursor:pointer;width:100%}
    .muted{color:#cfcfcf}
    .row{display:flex;gap:12px}
    .small{font-size:13px;color:var(--muted)}
    .success { background: rgba(0,200,120,0.12); color: #baf3d2; padding:12px; border-radius:10px; margin-top:12px; display:none; }
    .center { text-align:center }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="checkout-card">
      <div class="center">
        <h2 style="color:var(--accent);margin:0">Complete Payment</h2>
        <p class="small" id="svc-desc">Preparingâ€¦</p>
      </div>

      <div style="margin-top:14px">
        <div class="field">
          <label>Service</label>
          <input type="text" id="service-name" readonly />
        </div>

        <div class="field">
          <label>Amount (KES)</label>
          <input type="number" id="amount" readonly />
        </div>

        <div class="field">
          <label>Your Phone (07xxxxxxxx)</label>
          <input type="tel" id="cust-phone" placeholder="07XXXXXXXX" />
        </div>

        <div class="field">
          <label>Username / Account (optional)</label>
          <input type="text" id="cust-ref" placeholder="Instagram/TikTok/YouTube link or username" />
        </div>

        <button class="confirm-btn" id="pay-now">Pay with M-PESA</button>

        <div id="pay-msg" class="small" style="margin-top:10px"></div>

        <div id="success-box" class="success">
          <div id="txn-ok">Payment completed</div>
          <div id="new-balance" style="margin-top:8px;font-weight:800"></div>
        </div>

        <div style="margin-top:12px" class="small">
          <strong>Till:</strong> 3420564 â€” <strong>Name:</strong> AKIDA RAJAB
        </div>
      </div>
    </div>
  </div>

  <script>
    function qp(name){ const p = new URLSearchParams(location.search); return p.get(name); }

    const svc = qp('service') || 'Unknown Service';
    const amt = parseFloat(qp('amount') || '0') || 0;
    document.getElementById('service-name').value = svc;
    document.getElementById('amount').value = amt;
    document.getElementById('svc-desc').textContent = svc.replace(/[-_]/g,' ');

    const STK_GATEWAY = 'https://quickmpesa.xyz/api/stkpush';
    const BAL_KEY = 'gtm_balance';

    function showMsg(text){ document.getElementById('pay-msg').textContent = text; }

    function updateBalanceUI(newBalance){
      localStorage.setItem(BAL_KEY, String(newBalance));
      document.getElementById('new-balance').textContent = 'Current Balance: KES ' + newBalance;
      document.getElementById('success-box').style.display = 'block';
    }

    // ðŸ”¥ WHATSAPP REDIRECT FUNCTION
    function redirectToWhatsApp() {
      const message = encodeURIComponent(
        `Hello, I have completed my payment for: ${svc} (KES ${amt}).`
      );

      // CHANGE THIS NUMBER TO YOUR WHATSAPP NUMBER
      window.location.href = `https://wa.me/254763986398?text=${message}`;
    }

    // ðŸ”¥ PAYMENT SUCCESS HANDLER (used for real/simulated)
    function handleSuccess() {
      const cur = parseFloat(localStorage.getItem(BAL_KEY) || '0');
      const nb = Math.round((cur + amt) * 100) / 100;
      updateBalanceUI(nb);
      showMsg('Payment completed.');

      // redirect automatically
      setTimeout(redirectToWhatsApp, 1200);
    }

    document.getElementById('pay-now').addEventListener('click', async function(){
      const phoneRaw = document.getElementById('cust-phone').value.trim();
      const ref = document.getElementById('cust-ref').value.trim() || svc;

      if (!phoneRaw) { showMsg('Enter phone number'); return; }
      let phone = phoneRaw;
      if (phone.startsWith('0')) phone = '254' + phone.slice(1);
      if (!/^2547\d{8}$/.test(phone)) { showMsg('Use phone like 07XXXXXXXX'); return; }
      if (!amt || amt < 1) { showMsg('Invalid amount'); return; }

      showMsg('â³ Initiating STK push â€” check your phone');

      try {
        const resp = await fetch(STK_GATEWAY, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            till: '3420564',
            name: 'AKIDA RAJAB',
            phone: phone,
            amount: amt,
            reference: ref
          })
        });

        const data = await resp.json();

        if (resp.ok && data && data.success) {
          showMsg('âœ… STK sent â€” enter your M-PESA PIN...');
          setTimeout(handleSuccess, 3500);
        } else {
          showMsg('âš ï¸ Gateway error, simulating payment for now.');
          setTimeout(handleSuccess, 2000);
        }

      } catch (err) {
        showMsg('Network error â€” simulating payment.');
        setTimeout(handleSuccess, 1600);
      }
    });

    (function(){
      const cur = parseFloat(localStorage.getItem(BAL_KEY) || '0');
      if (cur > 0) {
        document.getElementById('new-balance').textContent = 'Current Balance: KES ' + cur;
        document.getElementById('success-box').style.display = 'block';
      }
    })();
  </script>
</body>
</html>
